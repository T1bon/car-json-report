<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Car JSON Report — Отчёт об автомобиле</title>

  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--accent:#1f6feb;--muted:#6b7280}
    body{font-family:Inter, system-ui, -apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
         background:var(--bg);margin:0;padding:24px;color:#111}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    header h1{margin:0;font-size:20px}
    .uploader{display:flex;gap:8px;align-items:center}
    .card{background:var(--card);border-radius:12px;padding:18px;
          box-shadow:0 6px 20px rgba(16,24,40,0.06);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .field{margin-bottom:8px}
    .label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    .value{font-weight:600}
    .gallery{display:flex;flex-wrap:wrap;gap:8px}
    .gallery img{width:120px;height:80px;object-fit:cover;border-radius:6px;
                 cursor:pointer;border:2px solid transparent;transition:0.2s}
    .gallery img:hover{border-color:var(--accent);transform:scale(1.03)}
    .auction-sheet{width:100%;height:auto;border-radius:8px;
                   box-shadow:0 6px 18px rgba(0,0,0,0.08);cursor:pointer}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .muted{color:var(--muted)}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;
         border:0;cursor:pointer}
    .small{font-size:13px;padding:6px 8px}
    pre.json-preview{max-height:260px;overflow:auto;background:#0f1724;
                     color:#e6eef8;padding:12px;border-radius:8px}
    /* Таблица */
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px 6px;text-align:left}
    th{color:var(--muted);font-weight:600}
    tr:hover td{background:#f9fafb}
    /* Важная информация */
    .attention-card{background:#fff3cd;border-left:5px solid #facc15;
      padding:12px 14px;border-radius:8px;margin-bottom:16px}
    .attention-card h3{margin:0 0 8px 0;font-size:16px;color:#92400e}
    .attention-card ul{margin:0;padding-left:20px;color:#78350f}
    .attention-card li{margin-bottom:4px}
    /* Lightbox */
    #lightboxOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,0.85);
      display:none;align-items:center;justify-content:center;
      z-index:1000;cursor:zoom-out;
    }
    #lightboxOverlay img{
      max-width:95%;max-height:95%;border-radius:10px;
      box-shadow:0 0 20px rgba(0,0,0,0.5);
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr} .two-col{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Car JSON Report — загрузка отчёта</h1>
      <div style="margin-left:auto" class="uploader">
        <input id="fileInput" type="file" accept=".json" />
        <button id="exampleBtn" class="btn small">Загрузить пример</button>
      </div>
    </header>

    <div id="reportArea" class="card" hidden>
      <div class="grid">
        <div>
          <h2 id="carTitle">—</h2>

          <!-- === Важная информация === -->
          <div id="attentionBlock"></div>

          <div class="field"><span class="label">VIN</span><div id="vin" class="value">—</div></div>
          <div class="field"><span class="label">Производитель</span><div id="company" class="value">—</div></div>
          <div class="field"><span class="label">Модель</span><div id="model" class="value">—</div></div>
          <div class="field"><span class="label">Год производства</span><div id="dateManufacture" class="value">—</div></div>
          <div class="field"><span class="label">Тип топлива</span><div id="fuelType" class="value">—</div></div>
          <div class="field"><span class="label">Объём двигателя</span><div id="engineCapacity" class="value">—</div></div>
          <div class="field"><span class="label">Дата регистрации</span><div id="registrationDate" class="value">—</div></div>

          <hr style="margin:14px 0">

          <!-- === История пробега === -->
          <h3>История пробега</h3>
          <div id="mileageTableContainer"></div>

          <hr style="margin:14px 0">

          <!-- === История торгов === -->
          <h3>История торгов</h3>
          <div id="historyAuctions"></div>
        </div>

        <aside>
          <h3>Галерея</h3>
          <div id="gallery" class="gallery"></div>

          <hr style="margin:12px 0">

          <h3>Аукционные листы</h3>
          <div class="two-col">
            <div>
              <img id="auctionListImg" class="auction-sheet" src="" alt="auction list">
              <div class="muted" style="font-size:13px;margin-top:6px">Оригинал</div>
            </div>
            <div>
              <img id="auctionTransImg" class="auction-sheet" src="" alt="auction translation">
              <div class="muted" style="font-size:13px;margin-top:6px">Перевод</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <button id="printBtn" class="btn small">Печатать / PDF</button>
          </div>
        </aside>
      </div>

      <hr style="margin:16px 0">

      <h3>JSON — превью</h3>
      <pre id="jsonPreview" class="json-preview"></pre>
    </div>

    <div id="emptyNotice" class="card">
      <div class="muted">Загрузите JSON-файл отчёта автомобиля (пример — example.json).</div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightboxOverlay"><img src="" alt="Просмотр изображения" /></div>

  <script>
    const $ = id => document.getElementById(id)
    const fileInput = $('fileInput')
    const exampleBtn = $('exampleBtn')
    const reportArea = $('reportArea')
    const jsonPreview = $('jsonPreview')
    const gallery = $('gallery')
    const historyBlock = $('historyAuctions')
    const auctionListImg = $('auctionListImg')
    const auctionTransImg = $('auctionTransImg')
    const printBtn = $('printBtn')
    const lightbox = $('lightboxOverlay')
    const lightboxImg = lightbox.querySelector('img')

    function openLightbox(src){lightboxImg.src=src;lightbox.style.display='flex'}
    function closeLightbox(){lightbox.style.display='none';lightboxImg.src=''}
    lightbox.addEventListener('click',closeLightbox)
    document.addEventListener('keydown',e=>{if(e.key==='Escape')closeLightbox()})

    function renderReport(data){
      reportArea.hidden=false
      const c=data.characteristics||{}
      $('carTitle').textContent=c.name||'—'
      $('vin').textContent=c.vin||'—'
      $('company').textContent=c.company||'—'
      $('model').textContent=c.model||'—'
      $('dateManufacture').textContent=c.dateManufacture||'—'
      $('fuelType').textContent=c.fuelType||'—'
      $('engineCapacity').textContent=c.engineCapacity||'—'
      $('registrationDate').textContent=c.registrationDate||'—'

      // === Важная информация ===
      const attentionBlock = $('attentionBlock')
      const attention = data.attention || []
      attentionBlock.innerHTML = ''
      if (attention.length) {
        const div = document.createElement('div')
        div.className = 'attention-card'
        div.innerHTML = '<h3>⚠️ Важная информация</h3><ul>' +
          attention.map(a => `<li>${a}</li>`).join('') +
          '</ul>'
        attentionBlock.appendChild(div)
      }

      // === Галерея ===
      gallery.innerHTML=''
      const photos=c.photos||[]
      if(!photos.length) gallery.innerHTML='<div class="muted">Фотографий нет</div>'
      else photos.forEach(src=>{
        const img=document.createElement('img')
        img.src=src;img.alt='photo'
        img.addEventListener('click',()=>openLightbox(src))
        gallery.appendChild(img)
      })

      // === Аукционные листы ===
      const auctionList=c.auctionList||''
      const auctionTrans=data.auctionSheetTranslationLink||''
      if(auctionList){auctionListImg.src=auctionList;auctionListImg.onclick=()=>openLightbox(auctionList)}
      if(auctionTrans){auctionTransImg.src=auctionTrans;auctionTransImg.onclick=()=>openLightbox(auctionTrans)}

      // === История пробега (таблица) ===
      const mileageContainer = $('mileageTableContainer')
      const mileage = data.historyMileage || {}
      mileageContainer.innerHTML = ''
      const entries = Object.entries(mileage)
        .map(([key,val])=>{
          let dateStr = key
          // если ключ — только год, добавляем "-01-01"
          if (/^\d{4}$/.test(key)) dateStr = `${key}-01-01`
          const d = new Date(dateStr)
          const formatted = !isNaN(d) ? d.toISOString().split('T')[0] : key
          return {date: formatted, value: val?.value ?? null}
        })
        .filter(x=>x.value!==null)
        .sort((a,b)=>new Date(a.date)-new Date(b.date))

      if(!entries.length){
        mileageContainer.innerHTML = '<div class="muted">Нет данных по пробегу</div>'
      }else{
        const table=document.createElement('table')
        table.innerHTML='<thead><tr><th>Дата</th><th>Пробег (км)</th></tr></thead>'
        const tbody=document.createElement('tbody')
        entries.forEach(e=>{
          const tr=document.createElement('tr')
          tr.innerHTML=`<td>${e.date}</td><td>${e.value.toLocaleString('ru-RU')}</td>`
          tbody.appendChild(tr)
        })
        table.appendChild(tbody)
        mileageContainer.appendChild(table)
      }

      // === История торгов ===
      historyBlock.innerHTML=''
      const hist=data.historyAuctions||[]
      if(!hist.length)historyBlock.innerHTML='<div class="muted">История торгов отсутствует</div>'
      else hist.forEach((h,idx)=>{
        const row=document.createElement('div')
        row.className='card';row.style.marginBottom='10px'
        row.innerHTML=`
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
            <div><div class="label">Аукцион</div>
              <div class="value">${h.group||h.asnetName||'—'}</div>
              <div class="muted" style="font-size:13px">${h.lotTradeDate||''}</div></div>
            <div style="text-align:right">
              <div class="label">Статус</div>
              <div class="value">${h.status?.value||h.status||'—'}</div>
              <div class="muted">${h.priceEnd?'Итог: '+h.priceEnd:''}</div>
            </div>
          </div>
          <div style="margin-top:8px">
            <div class="muted">Фото лота:</div>
            <div class="gallery" id="gallery-${idx}"></div>
          </div>`
        historyBlock.appendChild(row)
        const g=row.querySelector(`#gallery-${idx}`)
        const photos=h.photos||[]
        if(!photos.length)g.innerHTML='<div class="muted">Нет фото</div>'
        else photos.forEach(p=>{
          const im=document.createElement('img')
          im.src=p;im.alt='lot';im.addEventListener('click',()=>openLightbox(p))
          g.appendChild(im)
        })
        if(h.auctionList){
          const link=document.createElement('div')
          link.style.marginTop='8px'
          link.innerHTML=`<a href="#" class="muted" onclick="openLightbox('${h.auctionList}');return false;">Открыть аукционный лист</a>`
          row.appendChild(link)
        }
      })

      jsonPreview.textContent=JSON.stringify(data,null,2)
    }

    // === Загрузка JSON ===
    fileInput.addEventListener('change',e=>{
      const f=e.target.files?.[0];if(!f)return
      const reader=new FileReader()
      reader.onload=ev=>{
        try{renderReport(JSON.parse(ev.target.result))}catch(err){alert('Ошибка JSON: '+err.message)}
      }
      reader.readAsText(f,'utf-8')
    })

    exampleBtn.addEventListener('click',async()=>{
      try{
        const r=await fetch('./example.json')
        if(!r.ok)throw 0
        const d=await r.json()
        renderReport(d)
      }catch{alert('example.json не найден — выберите файл вручную.')}
    })

    printBtn.addEventListener('click',()=>window.print())
  </script>
</body>
</html>
