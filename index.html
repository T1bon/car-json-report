<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Car JSON Report — Загрузчик отчёта</title>
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--accent:#1f6feb;--muted:#6b7280}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); margin:0; padding:24px; color:#111}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    header h1{margin:0;font-size:20px}
    .uploader{display:flex;gap:8px;align-items:center}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(16,24,40,0.06);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .field{margin-bottom:8px}
    .label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    .value{font-weight:600}
    img.responsive{max-width:100%;height:auto;border-radius:8px;display:block}
    .gallery{display:flex;flex-wrap:wrap;gap:8px}
    .gallery img{width:120px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid transparent}
    .gallery img:hover{border-color:var(--accent)}
    .auction-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .auction-sheet {width:100%;height:auto;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .muted{color:var(--muted)}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .small{font-size:13px;padding:6px 8px}
    .notice{font-size:13px;color:var(--muted)}
    pre.json-preview{max-height:260px;overflow:auto;background:#0f1724;color:#e6eef8;padding:12px;border-radius:8px}
    @media(max-width:980px){.grid{grid-template-columns:1fr} .two-col{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>JapanStat - Viewer</h1>
      <div style="margin-left:auto" class="uploader">
        <input id="fileInput" type="file" accept=".json" />
        <button id="exampleBtn" class="btn small">Загрузить пример</button>
      </div>
    </header>

    <div id="reportArea" class="card" hidden>
      <!-- Основной блок -->
      <div class="grid">
        <div>
          <h2 id="carTitle">—</h2>
          <div class="field"><span class="label">VIN</span><div id="vin" class="value">—</div></div>
          <div class="field"><span class="label">Производитель</span><div id="company" class="value">—</div></div>
          <div class="field"><span class="label">Модель</span><div id="model" class="value">—</div></div>
          <div class="field"><span class="label">Год производства</span><div id="dateManufacture" class="value">—</div></div>
          <div class="field"><span class="label">Тип топлива</span><div id="fuelType" class="value">—</div></div>
          <div class="field"><span class="label">Объём двигателя</span><div id="engineCapacity" class="value">—</div></div>
          <div class="field"><span class="label">Дата регистрации</span><div id="registrationDate" class="value">—</div></div>

          <hr style="margin:14px 0">

          <h3>История пробега</h3>
          <div id="mileageBlock" class="muted">—</div>

          <hr style="margin:14px 0">

          <h3>История торгов</h3>
          <div id="historyAuctions"></div>

        </div>

        <aside>
          <h3>Галерея</h3>
          <div id="gallery" class="gallery"></div>

          <hr style="margin:12px 0">

          <h3>Аукционные листы</h3>
          <div class="muted">Аукционный лист (оригинал) и перевод</div>
          <div style="margin-top:8px" class="two-col">
            <div>
              <a id="auctionListLink" target="_blank" rel="noopener">
                <img id="auctionListImg" class="auction-sheet" src="" alt="auction list">
              </a>
              <div class="muted" style="font-size:13px;margin-top:6px">Оригинал — клик для открытия</div>
            </div>
            <div>
              <a id="auctionTransLink" target="_blank" rel="noopener">
                <img id="auctionTransImg" class="auction-sheet" src="" alt="auction translation">
              </a>
              <div class="muted" style="font-size:13px;margin-top:6px">Перевод — клик для открытия</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <button id="printBtn" class="btn small">Печатать / Сохранить как PDF</button>
          </div>
        </aside>
      </div>

      <hr style="margin:16px 0">

      <h3>JSON — превью (для отладки)</h3>
      <pre id="jsonPreview" class="json-preview"></pre>

    </div>

    <div id="emptyNotice" class="card">
      <div class="notice">Загрузите JSON-файл отчёта автомобиля (пример приложен). Сайт поддерживает поля:<br>
      <strong>characteristics</strong> (name, vin, dateManufacture, company, model, fuelType, engineCapacity, registrationDate, auctionList, photos), <strong>historyAuctions</strong> (photos, auctionList, lotTradeDate и т.д.), <strong>auctionSheetTranslationLink</strong>.</div>
    </div>

  </div>

  <script>
    // Помощники
    const $ = id => document.getElementById(id)
    const fileInput = $('fileInput')
    const exampleBtn = $('exampleBtn')
    const reportArea = $('reportArea')
    const jsonPreview = $('jsonPreview')
    const gallery = $('gallery')
    const historyBlock = $('historyAuctions')
    const auctionListImg = $('auctionListImg')
    const auctionListLink = $('auctionListLink')
    const auctionTransImg = $('auctionTransImg')
    const auctionTransLink = $('auctionTransLink')
    const printBtn = $('printBtn')

    function safeGet(obj, path, def = null) {
      try {
        return path.split('.').reduce((s,k)=>s && s[k] !== undefined ? s[k] : null, obj) ?? def
      } catch(e){ return def }
    }

    function renderReport(data) {
      reportArea.hidden = false
      // показать основные характеристики
      const c = data.characteristics || {}
      $('carTitle').textContent = c.name || c.nameFull || '—'
      $('vin').textContent = c.vin || c.vinFull || '—'
      $('company').textContent = c.company || '—'
      $('model').textContent = c.model || '—'
      $('dateManufacture').textContent = c.dateManufacture || '—'
      $('fuelType').textContent = c.fuelType || '—'
      $('engineCapacity').textContent = c.engineCapacity || '—'
      $('registrationDate').textContent = c.registrationDate || '—'

      // Галерея
      gallery.innerHTML = ''
      const photos = c.photos || []
      if(photos.length === 0) gallery.innerHTML = '<div class="muted">Фотографий нет</div>'
      photos.forEach(src => {
        const img = document.createElement('img')
        img.src = src
        img.alt = 'photo'
        img.className = 'responsive'
        img.style.width = '120px'
        img.style.height = '80px'
        img.style.objectFit = 'cover'
        img.addEventListener('click', ()=> window.open(src, '_blank'))
        gallery.appendChild(img)
      })

      // Аукционный лист
      const auctionList = c.auctionList || ''
      const auctionTrans = data.auctionSheetTranslationLink || data.translatedAuctionList || ''
      if(auctionList) {
        auctionListImg.src = auctionList
        auctionListLink.href = auctionList
      } else {
        auctionListImg.src = ''
        auctionListLink.removeAttribute('href')
        auctionListImg.alt = 'нет аукционного листа'
        auctionListImg.style.display = auctionList ? 'block' : 'none'
      }
      if(auctionTrans) {
        auctionTransImg.src = auctionTrans
        auctionTransLink.href = auctionTrans
      } else {
        auctionTransImg.src = ''
        auctionTransLink.removeAttribute('href')
        auctionTransImg.style.display = auctionTrans ? 'block' : 'none'
      }

      // История пробега
      const mileage = data.historyMileage || {}
      const mEntries = Object.entries(mileage).map(([k,v]) => `${k}: ${v && v.value !== undefined ? v.value : JSON.stringify(v)}`)
      $('mileageBlock').textContent = mEntries.length ? mEntries.join(' • ') : 'Нет данных'

      // История торгов
      historyBlock.innerHTML = ''
      const hist = data.historyAuctions || []
      if(hist.length === 0) {
        historyBlock.innerHTML = '<div class="muted">История торгов отсутствует</div>'
      } else {
        hist.forEach((h, idx) => {
          const row = document.createElement('div')
          row.className = 'card'
          row.style.marginBottom = '10px'
          row.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
              <div>
                <div class="label">Аукцион</div>
                <div class="value">${h.group || h.asnetName || '—'}</div>
                <div class="muted" style="font-size:13px">${h.lotTradeDate || h.lot?.tradeDate || ''} ${h.lotTradeTime || h.lot?.tradeTime || ''}</div>
              </div>
              <div style="text-align:right">
                <div class="label">Статус</div>
                <div class="value">${safeGet(h,'status.value') || h.status || '—'}</div>
                <div class="muted">${h.priceEnd ? 'Итог: '+h.priceEnd : ''}</div>
              </div>
            </div>
            <div style="margin-top:8px">
              <div class="muted">Фотографии лота:</div>
              <div class="gallery" id="gallery-${idx}"></div>
            </div>
          `
          historyBlock.appendChild(row)

          // добавить фото
          const g = row.querySelector(`#gallery-${idx}`)
          const photos = h.photos || []
          if(!photos.length) {
            g.innerHTML = '<div class="muted">фотографий нет</div>'
          } else {
            photos.forEach(p => {
              const im = document.createElement('img')
              im.src = p
              im.alt = 'lot photo'
              im.style.width = '120px'
              im.style.height = '80px'
              im.style.objectFit = 'cover'
              im.style.borderRadius = '6px'
              im.addEventListener('click', ()=> window.open(p, '_blank'))
              g.appendChild(im)
            })
          }

          // если у записи есть auctionList, показать thumbnail с возможностью открыть
          if(h.auctionList) {
            const link = document.createElement('div')
            link.style.marginTop = '8px'
            link.innerHTML = `<a href="${h.auctionList}" target="_blank" class="muted">Открыть аукционный лист лота</a>`
            row.appendChild(link)
          }
        })
      }

      // показать JSON превью (с форматированием)
      try {
        jsonPreview.textContent = JSON.stringify(data, null, 2)
      } catch(e) {
        jsonPreview.textContent = 'Ошибка показа JSON'
      }
    }

    // загрузка файла с диска
    fileInput.addEventListener('change', (ev)=>{
      const f = ev.target.files && ev.target.files[0]
      if(!f) return
      const reader = new FileReader()
      reader.onload = e => {
        try {
          const parsed = JSON.parse(e.target.result)
          renderReport(parsed)
        } catch(err) {
          alert('Ошибка парсинга JSON: ' + err.message)
        }
      }
      reader.readAsText(f, 'utf-8')
    })

    // кнопка загрузки примера — мы подгрузим встроенный пример (для демонстрации)
    exampleBtn.addEventListener('click', async ()=>{
      // встроенный пример minimal (если хочешь, можно подменить URL на локальный или взять из textarea)
      // Но для оффлайн-режима — предлагаем открыть пример через встроенный fetch к файлу example.json в той же папке (если есть).
      // Попробуем загрузить /example.json — если его нет, откроем окно выбора файла.
      try {
        const resp = await fetch('./example.json')
        if(!resp.ok) throw new Error('no example.json')
        const data = await resp.json()
        renderReport(data)
      } catch(e) {
        alert('Пример не найден в example.json — пожалуйста, просто выбери твой загруженный JSON через кнопку Файл.')
      }
    })

    // печать / сохранить как PDF
    printBtn.addEventListener('click', ()=> window.print())

    // При загрузке страницы — прячем reportArea (он изначально скрыт)
  </script>
</body>
</html>
